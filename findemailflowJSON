kind: AdaptiveDialog
modelDescription: find email and ask the user if they would like to reply
beginDialog:
  kind: OnRecognizedIntent
  id: main
  intent: {}
  actions:
    - kind: AdaptiveCardPrompt
      id: PFkOzY
      displayName: Adaptive Card - get emails
      card: |-
        {
          "type": "AdaptiveCard",
          "$schema": "https://adaptivecards.io/schemas/adaptive-card.json",
          "version": "1.5",
          "actions": [
            {
              "type": "Action.Submit",
              "title": "Find",
              "id": "submitBtn"
            }
          ],
          "body": [
            {
              "type": "TextBlock",
              "text": "Please fill in the criteria you would like to search for:",
              "wrap": true,
              "id": "textBlock"
            },
            {
              "type": "Input.Text",
              "label": "From",
              "placeholder": "person@owi.com",
              "id": "fromInput"
            },
            {
              "type": "Input.Text",
              "label": "To",
              "placeholder": "me, person@owi.com",
              "id": "toInput"
            },
            {
              "type": "Input.Text",
              "label": "Subject",
              "placeholder": "ex. Order ###",
              "id": "subjectInput"
            },
            {
              "type": "Input.Text",
              "label": "Folder",
              "placeholder": "ex. Inbox, Archive, Drafts",
              "id": "folderInput"
            }
          ]
        }
      output:
        binding:
          actionSubmitId: Topic.actionSubmitId
          folderInput: Topic.folderInput
          fromInput: Topic.fromInput
          subjectInput: Topic.subjectInput
          toInput: Topic.toInput

      outputType:
        properties:
          actionSubmitId: String
          folderInput: String
          fromInput: String
          subjectInput: String
          toInput: String

    - kind: SetVariable
      id: setVariable_A4emmr
      variable: Topic.flderSearch
      value: Inbox

    - kind: ConditionGroup
      id: conditionGroup_mOxkzD
      conditions:
        - id: conditionItem_4LChXV
          condition: =!IsBlank(Topic.folderInput)
          actions:
            - kind: SetVariable
              id: setVariable_LxuIuS
              variable: Topic.flderSearch
              value: =Topic.folderInput

    - kind: SendActivity
      id: SendActivity_oSJ46n
      activity: "Searching for emails that match the criteria: "

    - kind: BeginDialog
      id: aLuazA
      input:
        binding:
          folderPath: =Topic.flderSearch
          from: =Topic.fromInput
          subjectFilter: =Topic.subjectInput
          toOrCc: =Topic.toInput

      dialog: cr689_customerCareAssistant.action.Office365Outlook-GetemailsV3
      output:
        binding:
          value: Topic.value

    - kind: InvokeAIBuilderModelAction
      id: invokeAIBuilderModelAction_haMaJP
      input:
        binding:
          emailTable: =JSON(Topic.value)

      output:
        binding:
          predictionOutput: Topic.foundEmailSummary

      aIModelId: a49adc21-1a43-4810-8c32-82c4b262ff24

    - kind: SetVariable
      id: setVariable_tBZMpP
      variable: Topic.numEmails
      value: =CountRows(Topic.value)

    - kind: ConditionGroup
      id: conditionGroup_Jss2a9
      conditions:
        - id: conditionItem_Evop4q
          condition: =Topic.numEmails = 10
          actions:
            - kind: SendActivity
              id: sendActivity_75hHsk
              activity: Displaying top 10 most relevant

        - id: conditionItem_eGr26m
          condition: =Topic.numEmails = 0
          actions:
            - kind: GotoAction
              id: AYlVRZ
              actionId: sendActivity_bZFcp8

    - kind: SendActivity
      id: 6TQYau
      activity: |-
        Emails Found:

        {Topic.foundEmailSummary.text}

    - kind: SendActivity
      id: sendActivity_kTATLL
      activity: "{Topic.numEmails}"

    - kind: ConditionGroup
      id: conditionGroup_DN4rmF
      conditions:
        - id: conditionItem_1Kb5ZY
          condition: =Topic.numEmails = 1
          actions:
            - kind: Question
              id: question_Gw4i3M
              interruptionPolicy:
                allowInterruption: true

              variable: Topic.emailReplyChoice
              prompt: Would you like to reply to this email?
              entity:
                kind: EmbeddedEntity
                sensitivityLevel: None
                definition:
                  kind: ClosedListEntity
                  items:
                    - id: yes
                      displayName: yes

                    - id: no
                      displayName: no

            - kind: ConditionGroup
              id: conditionGroup_JIe85L
              conditions:
                - id: conditionItem_HLEmoK
                  condition: =Topic.emailReplyChoice = 'cr689_customerCareAssistant.topic.findemailasktoreply.main.question_Gw4i3M'.yes
                  actions:
                    - kind: BeginDialog
                      id: DgeATu
                      input:
                        binding:
                          emailFound: =First(Topic.value).body
                          messageID: =First(Topic.value).id
                          toEmails: =First(Topic.value).from

                      dialog: cr689_customerCareAssistant.topic.replyemail

              elseActions:
                - kind: EndDialog
                  id: aCyRam

        - id: conditionItem_M2hZsm
          condition: =Topic.numEmails > 1
          actions:
            - kind: Question
              id: question_UVmwwj
              interruptionPolicy:
                allowInterruption: true

              variable: Topic.emailReply
              prompt: Would you like to reply to any of these email
              entity:
                kind: BooleanPrebuiltEntity
                sensitivityLevel: None

            - kind: ConditionGroup
              id: conditionGroup_YBzgZ2
              conditions:
                - id: conditionItem_Mkc424
                  condition: =Topic.emailReply = true
                  actions:
                    - kind: Question
                      id: question_iG6sKN
                      interruptionPolicy:
                        allowInterruption: true

                      variable: init:Topic.emailChoice
                      prompt: Which email would you like to reply to? Enter a number
                      entity: NumberPrebuiltEntity

                    - kind: ConditionGroup
                      id: conditionGroup_YfPfpB
                      conditions:
                        - id: conditionItem_jMPS5O
                          condition: =Topic.emailChoice > Topic.numEmails
                          actions:
                            - kind: SendActivity
                              id: sendActivity_kdmQcc
                              activity: That was not a valid choice.

                            - kind: GotoAction
                              id: 2SU6Yi
                              actionId: question_iG6sKN

                        - id: conditionItem_GoeHQQ
                          condition: =Topic.emailChoice <= Topic.numEmails && Topic.emailChoice > 0
                          actions:
                            - kind: SendActivity
                              id: sendActivity_7tBoPl
                              activity: |-
                                you want to respond to this email

                                From:{Index(Topic.value, Topic.emailChoice).from}

                                Subject: {Index(Topic.value, Topic.emailChoice).subject}

                                Body:
                                 {Index(Topic.value, Topic.emailChoice).body}

                      elseActions:
                        - kind: SendActivity
                          id: sendActivity_eLnOlo
                          activity: Ending reply request

                        - kind: EndDialog
                          id: gwgkZS

              elseActions:
                - kind: EndDialog
                  id: HUPl8B

            - kind: BeginDialog
              id: yTBaab
              input:
                binding:
                  emailFound: =Index(Topic.value, Topic.emailChoice).body
                  messageID: =Index(Topic.value, Topic.emailChoice).id
                  toEmails: =Index(Topic.value, Topic.emailChoice).from

              dialog: cr689_customerCareAssistant.topic.replyemail

      elseActions:
        - kind: SendActivity
          id: sendActivity_bZFcp8
          activity: No emails found

        - kind: EndDialog
          id: C8eiud

inputType: {}
outputType: {}
